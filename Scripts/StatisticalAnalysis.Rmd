---
title: "Exploratory statistical analyses"
output: html_notebook
---
```{r}
require(mblm)
```


```{r}
load("~/Desktop/Git_projects/ASD/Data/ps_bac_rarefy_iter.RData")
```

convert time to continous variable
```{r}
sample_data(ps16S_bac_rarefy_iter)$time <-sample_data(ps16S_bac_rarefy_iter)$Timepoint


index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")

sample_data(ps16S_bac_rarefy_iter)$time <- as.numeric(values[match(sample_data(ps16S_bac_rarefy_iter)$time, index)])

```


#Edaphic conditions
```{r}
md <- data.frame(sample_data(ps16S_bac_rarefy_iter))
#ph with regression
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = pH, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + facet_wrap("Treatment")

#ECwith regression
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = EC, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + facet_wrap("Treatment")

#nitrate with regression
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateN, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = NitrateN, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateN, color = Treatment, group = time)) + facet_wrap("Treatment")

ggplot(md) + geom_boxplot(aes(x = time, y = AmmoniumN, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = AmmoniumN, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = AmmoniumN, color = Treatment, group = time)) + facet_wrap("Treatment")
```

edaphic over time (without 55 dap point)
```{r}
md <- data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6")))
#ph with regression
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = pH, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + facet_wrap("Treatment")

#EC with regression
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = EC, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + facet_wrap("Treatment")

#nitrate with regression
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateN, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = NitrateN, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateN, color = Treatment, group = time)) + facet_wrap("Treatment")

#ammonium with regression
ggplot(md) + geom_boxplot(aes(x = time, y = AmmoniumN, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = AmmoniumN, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = AmmoniumN, color = Treatment, group = time)) + facet_wrap("Treatment")
```
ordination of edaphic conditions
```{r}
#switch md to either include or exclude t 55 days
md <- data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6")))
#md <- data.frame(sample_data(ps16S_bac_rarefy_iter)

md_heatmap <- md %>% select(time, Treatment, pH, EC, NitrateN, AmmoniumN) %>% filter(time != 0)
ord <- metaMDS(md_heatmap[,3:6], distance = "euclidian" , data = md_heatmap[,3:6])

plot(ord, display = "sites")

dune.fit <- envfit(ord ~ pH + EC + NitrateN + AmmoniumN, md_heatmap[,3:6], 
                   choices=c(1:2)) 
dune.fit

#base R plot
plot(ord, display = "sites", type = "n")
points(ord, display = "sites", col = "black", cex = 1.25)
plot(dune.fit)

spp.scrs <- as.data.frame(scores(dune.fit, display = "vectors"))
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs))

df <-data.frame(ord$points)
df$time <- md_heatmap$time
df$treatment <- md_heatmap$Treatment
df$pH <- md_heatmap$pH
  ggplot(data=df, aes(x=MDS1, y=MDS2)) + theme_bw(16) + 
            labs(x="MDS Axis 1",y="MDS Axis 2") +
            theme(panel.grid=element_blank()) + geom_point(aes(shape=as.factor(time), color = treatment), size = 7) +
  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = spp.scrs,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  geom_text(data = spp.scrs, aes(x = NMDS1, y = NMDS2, label = Species),
            size = 3)
  
```
heat map of edaphic conditions
```{r}
#switch md to either include or exclude t 55 days
#md <- data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6")))
md <- data.frame(sample_data(ps16S_bac_rarefy_iter))

md_heatmap <- md %>% select(time, Treatment, pH, EC, NitrateNperkgDrySoil, NH4NperkgDrySoil) %>% filter(time != 0)
#to remove time 0 if we look at nitrate and ammonia values bc they are missing at t0
#md_heatmap <- md %>% select(time, Treatment, pH, EC, NitrateNperkgDrySoil, NH4NperkgDrySoil) %>% filter(time != 0)
heatmap(as.matrix(md_heatmap[3:6]), scale = "column", Colv = NA, Rowv = NA)
```


#Community data

#Alpha Diversity
Alpha diversity over time (with 55 dap point)
```{r}
alphadiv<-estimate_richness(ps16S_bac_rarefy_iter)
alphadiv$treatment <- sample_data(ps16S_bac_rarefy_iter)$Treatment
alphadiv$time <- sample_data(ps16S_bac_rarefy_iter)$time
alphadiv$wheatm <- sample_data(ps16S_bac_rarefy_iter)$WheatM
alphadiv$pH <- sample_data(ps16S_bac_rarefy_iter)$pH

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Observed, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Observed, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

#lm but wont meet requirements of lm
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% lm(Observed ~ time, data = .) %>% summary() %>% print() %>% residuals() %>% hist()
}

#non-parametric regression
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% mblm(Observed ~ time, data = .) %>% summary() %>% print() 
}

```

Alpha diversity over time (without 55 dap point)
```{r}
#without 55 days after planting point
alphadiv<-estimate_richness(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))
alphadiv$treatment <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Treatment
alphadiv$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$time
alphadiv$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$WheatM
alphadiv$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$pH

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Observed, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Observed, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

#lm but wont meet requirements of lm
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% lm(Observed ~ time, data = .) %>% summary() %>% print() %>% residuals() %>% hist()
}

#non-parametric regression
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% mblm(Observed ~ time, data = .) %>% summary() %>% print() 
}
```

#beta-diversity
```{r}

com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$time
#plot nmds 
plot(com_df_nmds$MDS1 ~ com_df_nmds$pH)
ggplot(com_df_nmds, aes(x = MDS1, y = pH, color = treatment, shape = wheatm, alpha = time)) + geom_point() + theme_classic() 

summary(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH))
hist(residuals(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH)))
#looks normal enough, but just in case heres a non-parametric regression
summary(mblm(MDS1 ~ pH, dataframe = com_df_nmds))
```
adonis testing
```{r}
ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ WheatM + Covercrop + Timepoint + pH , data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))
```

pH is a signifiacnt predicotr along axis 1

#corncob regression models
```{r}
#remotes::install_github("statdivlab/corncob")
require(corncob)
```

CORNCOB regression
subset samples to high and low nitrogen and condense at order level for this initial pass. 
```{r}
cc_ps<- ps16S_bac_rarefy_iter %>% tax_glom("Phylum")
#350 genera left to model
```

alter plotting function to color bars that do not overlap 0
```{r}
plot.differentialTest2 <- function(x, level = NULL, data_only = FALSE, ...) {
  signif_taxa <- x$significant_taxa
  if ("phyloseq" %in% class(x$data)) {
    if (!is.null(x$data@tax_table)) {
      signif_taxa <- otu_to_taxonomy(signif_taxa, x$data, level = level)
      if (length(unique(signif_taxa)) != length(unique(x$significant_taxa))) {
        # Make sure if repeated taxa add unique otu identifiers
        signif_taxa <- paste0(signif_taxa, " (", x$significant_taxa, ")")
      }
    }
  }
  if (length(x$significant_models) != 0) {
    var_per_mod <- length(x$restrictions_DA) + length(x$restrictions_DV)
    total_var_count <- length(signif_taxa) * var_per_mod
    df <- as.data.frame(matrix(NA, nrow = total_var_count, ncol = 5))
    colnames(df) <- c("x", "xmin", "xmax", "taxa", "variable")
    qval <- stats::qnorm(.975)
    restricts_mu <- attr(x$restrictions_DA, "index")
    restricts_phi <- attr(x$restrictions_DV, "index")

    count <- 1
    for (i in 1:length(x$significant_models)) {

      # Below from print_summary_bbdml, just to get coefficient names
      tmp <- x$significant_models[[i]]
      coefs.mu <- tmp$coefficients[1:tmp$np.mu,, drop = FALSE]
      rownames(coefs.mu) <- paste0(substring(rownames(coefs.mu), 4), "\nDifferential Abundance")
      coefs.mu <- coefs.mu[restricts_mu,, drop = FALSE]

      coefs.phi <- tmp$coefficients[(tmp$np.mu + 1):nrow(tmp$coefficients),, drop = FALSE]
      rownames(coefs.phi) <- paste0(substring(rownames(coefs.phi), 5), "\nDifferential Variability")
      coefs.phi <- coefs.phi[restricts_phi - tmp$np.mu,, drop = FALSE]

      coefs <- rbind(coefs.mu, coefs.phi)
      for (j in 1:var_per_mod) {
        df[count, 1:3] <- c(coefs[j, 1], coefs[j, 1] - qval * coefs[j, 2],
                        coefs[j, 1] + qval * coefs[j, 2])
        df[count, 4:5] <- c(signif_taxa[i], rownames(coefs)[j])
        count <- count + 1
      }
    }
    if (!(data_only)) {
    # global variables warning suppression
    taxa <- xmin <- xmax <- NULL
    df <- df[order(df$taxa),]
    ggplot2::ggplot(df, ggplot2::aes(x = x, y = taxa)) +
      ggplot2::geom_vline(xintercept = 0, color = "gray50", lty = "dashed",
                          alpha = 0.75, lwd = 1) +
      ggplot2::geom_point() +
      ggplot2::geom_errorbarh(ggplot2::aes(xmin = xmin, xmax = xmax, colour = xmin<=0 & xmax <= 0| xmin>=0 & xmax >= 0), height = .3) +
      ggplot2::theme_bw() +
      ggplot2::facet_wrap(~variable, scales = "free_x", nrow = 1) +
      ggplot2::labs(title = "", x = "", y = "Taxa") +
      ggplot2::scale_y_discrete(limits = rev(df$taxa)) +
      ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +
      ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))+
      ggplot2::theme(legend.position = "none")
    } else {
    return(df)
  }
  } else {
    message("No taxa were found to be significantly different using your model specification. \nPlease verify that your formulas are correctly specified.")
  }
}
```

from B.Martin's git page on interpreting effect sizes. 

"Not exactly, because it is not a linear model. By default, corncob uses the logit link between the expected relative abundance and the covariates. This can be interpreted on the log-odds scale, similar to with logistic regression. Typically, I recommend users interpret parameters directly on the logit scale, for example "The expected difference in the logit-transformed relative abundance between two samples that differ by one unit change in [my covariate] controlling for [all controls] is [coefficient value]"

"The difference between the formulas and the null version of the formulas are the variables that we test. We will go through several examples, starting with a test for differential abundance across the DayAmdmt coefficient."

explanations of model specificaiton can be found in examples at end of the vignette. 
https://cran.r-project.org/web/packages/corncob/vignettes/corncob-intro.html

Run model at genus level. 
 
```{r}
cc_ps<- ps16S_bac_rarefy_iter %>% tax_glom("Genus") %>% subset_samples(Timepoint != "t6")
set.seed(1)
#Testing for taxa that significantly respond to Nitrogen, pH, and POA2021 cover, while controlling for POA2021 cover on dispersion.
#da_analysis <- differentialTest(formula = ~ X2021.Spring.Poa.. + Nitrogen + pH, phi.formula = ~  X2021.Spring.Poa.., formula_null = ~ 1, phi.formula_null = ~  X2021.Spring.Poa.., test = "Wald", boot = FALSE, data = turf16S_cc_rarefy, fdr_cutoff = 0.05)
da_analysis <- differentialTest(formula = ~  pH, phi.formula = ~   pH, formula_null = ~ 1, phi.formula_null = ~ pH, test = "Wald", boot = FALSE, data = cc_ps, fdr_cutoff = 0.05)

summary(da_analysis)
da_analysis$significant_taxa
da_analysis$significant_models
otu_to_taxonomy(OTU=da_analysis$significant_taxa,data=ps16S_bac_rarefy_iter)

plot.differentialTest2(da_analysis, level= c("Phylum","Order", "Family", "Genus"))

plot.differentialTest2(da_analysis, level= c("Family"))
```


