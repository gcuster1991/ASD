---
title: "Exploratory statistical analyses"
output: html_notebook
---
```{r}
require(mblm)
require(phyloseq)
require(ggplot2)
require(tidyverse)
require(rstatix)
require(ggpubr)
```


```{r}
load("~/Desktop/Git_projects/ASD/Data/ps_bac_rarefy_iter.RData")
```


```{r}
#create super long color vector
col_vector <- c("#000000", "#5B656C","#FFFF00","#F4D749", "#1CE6FF","#0AA6D8", "#FF34FF","#D790FF", "#FF4A46", "#FF2F80",
                "#008941", "#006FA6", "#A30059",
        "#FFDBE5", "#7A4900", "#0000A6", "#63FFAC", "#B79762", "#004D43", "#8FB0FF", "#997D87",
        "#5A0007", "#809693",  "#1B4400", "#4FC601", "#3B5DFF", "#4A3B53", 
        "#61615A", "#BA0900", "#6B7900", "#00C2A0", "#FFAA92", "#FF90C9", "#B903AA", "#D16100",
        "#DDEFFF", "#000035", "#7B4F4B", "#A1C299", "#300018", "#0AA6D8", "#013349", "#00846F",
        "#372101", "#FFB500", "#C2FFED", "#A079BF", "#CC0744", "#C0B9B2", "#C2FF99", "#001E09",
        "#00489C", "#6F0062", "#0CBD66", "#EEC3FF", "#456D75", "#B77B68", "#7A87A1", "#788D66",
        "#885578", "#FAD09F", "#FF8A9A", "#D157A0", "#BEC459", "#456648", "#0086ED", "#886F4C",
        
        "#34362D", "#B4A8BD", "#00A6AA", "#452C2C", "#636375", "#A3C8C9", "#FF913F", "#938A81",
        "#575329", "#00FECF", "#B05B6F", "#8CD0FF", "#3B9700", "#04F757", "#C8A1A1", "#1E6E00",
        "#7900D7", "#A77500", "#6367A9", "#A05837", "#6B002C", "#772600",  "#9B9700",
        "#549E79", "#201625", "#72418F", "#BC23FF", "#99ADC0", "#3A2465", "#922329",
        "#5B4534", "#FDE8DC",  "#0089A3", "#CB7E98", "#A4E804", "#324E72", "#6A3A4C",
        "#83AB58", "#001C1E", "#D1F7CE", "#004B28", "#C8D0F6", "#A3A489", "#806C66", "#222800",
        "#BF5650", "#E83000", "#66796D", "#DA007C", "#FF1A59", "#8ADBB4", "#1E0200", "#5B4E51",
        "#C895C5", "#320033", "#FF6832", "#66E1D3", "#CFCDAC", "#D0AC94", "#7ED379", "#012C58",
        
        "#7A7BFF", "#D68E01", "#353339", "#78AFA1", "#FEB2C6", "#75797C", "#837393", "#943A4D",
        "#B5F4FF", "#D2DCD5", "#9556BD", "#6A714A", "#001325", "#02525F", "#0AA3F7", "#E98176",
        "#DBD5DD", "#5EBCD1", "#3D4F44", "#7E6405", "#02684E", "#962B75", "#8D8546", "#9695C5",
        "#E773CE", "#D86A78", "#3E89BE", "#CA834E", "#518A87", "#5B113C", "#55813B", "#E704C4",
        "#00005F", "#A97399", "#4B8160", "#59738A", "#FF5DA7", "#F7C9BF", "#643127", "#513A01",
        "#6B94AA", "#51A058", "#A45B02", "#1D1702", "#E20027", "#E7AB63", "#4C6001", "#9C6966",
        "#64547B", "#97979E", "#006A66", "#391406",  "#0045D2", "#006C31", "#DDB6D0",
        "#7C6571", "#9FB2A4", "#00D891", "#15A08A", "#BC65E9", "#FFFFFE", "#C6DC99", "#203B3C",

        "#671190", "#6B3A64", "#F5E1FF", "#FFA0F2", "#CCAA35", "#374527", "#8BB400", "#797868",
        "#C6005A", "#3B000A", "#C86240", "#29607C", "#402334", "#7D5A44", "#CCB87C", "#B88183",
        "#AA5199", "#B5D6C3", "#A38469", "#9F94F0", "#A74571", "#B894A6", "#71BB8C", "#00B433",
        "#789EC9", "#6D80BA", "#953F00", "#5EFF03", "#E4FFFC", "#1BE177", "#BCB1E5", "#76912F",
        "#003109", "#0060CD", "#D20096", "#895563", "#29201D", "#5B3213", "#A76F42", "#89412E",
        "#1A3A2A", "#494B5A", "#A88C85", "#F4ABAA", "#A3F3AB", "#00C6C8", "#EA8B66", "#958A9F",
        "#BDC9D2", "#9FA064", "#BE4700", "#658188", "#83A485", "#453C23", "#47675D", "#3A3F00",
        "#061203", "#DFFB71", "#868E7E", "#98D058", "#6C8F7D", "#D7BFC2", "#3C3E6E", "#D83D66",

        "#2F5D9B", "#6C5E46", "#D25B88", "#5B656C", "#00B57F", "#545C46", "#866097", "#365D25",
        "#252F99", "#00CCFF", "#674E60", "#FC009C", "#92896B")
```


convert time to continous variable
```{r}
sample_data(ps16S_bac_rarefy_iter)$time <-sample_data(ps16S_bac_rarefy_iter)$Timepoint


index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")

sample_data(ps16S_bac_rarefy_iter)$time <- as.numeric(values[match(sample_data(ps16S_bac_rarefy_iter)$time, index)])

ps16S_bac_rarefy_iter <- subset_samples(ps16S_bac_rarefy_iter, Treatment != "UTC")

```


#Edaphic conditions
edaphic over time (with 55 dap point)
```{r}
md <- data.frame(sample_data(ps16S_bac_rarefy_iter))
#ph with regression
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = pH, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + facet_wrap("Treatment")

#ECwith regression
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = EC, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + facet_wrap("Treatment")

#nitrate with regression
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateN, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = NitrateN, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateN, color = Treatment, group = time)) + facet_wrap("Treatment")

ggplot(md) + geom_boxplot(aes(x = time, y = AmmoniumN, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = AmmoniumN, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = AmmoniumN, color = Treatment, group = time)) + facet_wrap("Treatment")
```

aov of physiochemical 
```{r}
#all samples
md<-data.frame(sample_data(ps16S_bac_rarefy_iter))
#global
#ph
mod<- aov(pH ~ Covercrop + Timepoint + WheatM, data = md)
shapiro_test(mod$residuals)
boxplot(md$pH ~ md$WheatM)
boxplot(md$pH ~ md$Covercrop)
boxplot(md$pH ~ md$Timepoint)
plot(TukeyHSD(mod, "WheatM"))

res_aov <- md %>% anova_test(pH ~ Covercrop + Timepoint + WheatM)
print(res_aov)

      
res_tukey <- md %>% tukey_hsd(formula = pH ~ Covercrop + Timepoint + WheatM)
print(res_tukey[res_tukey$p.adj<0.06,])
```

```{r}
sort(mod$residuals, decreasing = T)
md_sub <- md %>% filter(sample.names != "asd-t7-a-201-2sppb-asd")
md_sub <- md_sub %>% filter(sample.names != "asd-t7-a-105-asdi")
mod<- aov(EC ~ Covercrop + Timepoint + WheatM, data = md_sub)
shapiro_test(mod$residuals)
hist(mod$residuals)
#normal enough

boxplot(md$EC ~ md$WheatM)
boxplot(md$EC ~ md$Covercrop)
boxplot(md$EC ~ md$Timepoint)


res_aov <- md_sub %>% anova_test(EC ~ Covercrop + Timepoint + WheatM)
print(res_aov)

      
res_tukey <- md_sub %>% tukey_hsd(formula = EC ~ Covercrop + Timepoint + WheatM)
print(res_tukey[res_tukey$p.adj<0.06,])
          
```


```{r}
#remove outliers and missing data

md<-data.frame(sample_data(ps16S_bac_rarefy_iter))
md_sub <- md %>% filter(sample.names != "asd-t1-a-102-tr")
md_sub <- md_sub %>% filter(sample.names != "asd-t3-a-301-asd")
md_sub <- md_sub %>% filter(sample.names != "asd-t3-a-201-2sppb")
md_sub <- md_sub %>% filter(sample.names != "asd-t1-a-103-cc")
md_sub_n <- md_sub %>% filter(Timepoint!= "t0")
md_sub_n <- md_sub_n %>% filter(NitrateNperkgDrySoil > 0)
min(md_sub_n$NitrateNperkgDrySoil)

#check residauls
mod <- aov(log(NitrateNperkgDrySoil) ~ Covercrop + Timepoint + WheatM, data = md_sub_n)
shapiro_test(mod$residuals)
hist(mod$residuals)


#xplore data
boxplot(log(md_sub_n$NitrateNperkgDrySoil) ~ md_sub_n$WheatM)
boxplot(log(md_sub_n$NitrateN) ~ md_sub_n$Covercrop)
boxplot(md_sub_n$NitrateNperkgDrySoil ~ md_sub_n$Covercrop)
boxplot(log(md_sub_n$NitrateNperkgDrySoil) ~ md_sub_n$Timepoint)

res_aov <- md_sub_n %>% anova_test(log(NitrateNperkgDrySoil) ~ Covercrop + Timepoint + WheatM)
print(res_aov)


      
res_tukey <- md_sub_n %>% tukey_hsd(formula = log(NitrateNperkgDrySoil) ~ Covercrop + Timepoint + WheatM)
print(res_tukey[res_tukey$p.adj<0.06,])


          
```

```{r}
#check residauls


md<-data.frame(sample_data(ps16S_bac_rarefy_iter))
md$NH4NperkgDrySoil

mod <- aov(log(NH4NperkgDrySoil) ~ Covercrop + Timepoint + WheatM, data = md)
shapiro_test(mod$residuals)
hist(mod$residuals)


#xplore data
boxplot(log(md$NH4NperkgDrySoil) ~ md$WheatM)
boxplot(md$NH4NperkgDrySoil ~ md$Covercrop)
boxplot(md$NH4NperkgDrySoil ~ md$Timepoint)


res_aov <- md %>% anova_test(log(NH4NperkgDrySoil) ~ Covercrop + Timepoint + WheatM)
print(res_aov)

      
res_tukey <- md %>% tukey_hsd(formula = log(NH4NperkgDrySoil) ~ Covercrop + Timepoint + WheatM)
print(res_tukey[res_tukey$p.adj<0.06,])
          
```


split by treatment and run anova
```{r}
#just ran and swtiched the response variable instaed of recoding or loopoing. I'm being lazy and want to get this done.
#checked res noramlity by chaing respone 
md<-data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5")))
#global
#ph
mod<- aov(log(NH4NperkgDrySoil) ~ Covercrop + WheatM, data = md)
shapiro_test(mod$residuals)
hist(mod$residuals)

mod<- aov(log(NitrateNperkgDrySoil) ~ Covercrop + WheatM, data = md)
shapiro_test(mod$residuals)
hist(mod$residuals)


boxplot(md$NH4NperkgDrySoil ~ md$WheatM)

boxplot(md$EC ~ md$Covercrop)

#boxplot(md$pH ~ md$Timepoint)


res_aov <- md %>% anova_test(pH ~ Covercrop  + WheatM)
print(res_aov)


res_aov <- md %>% anova_test(EC ~ Covercrop  + WheatM)
print(res_aov)

res_aov <- md %>% anova_test(log(NH4NperkgDrySoil) ~ Covercrop  + WheatM)
print(res_aov)

res_aov <- md %>% anova_test(log(NitrateNperkgDrySoil) ~ Covercrop  + WheatM)
print(res_aov)


      
res_tukey <- md %>% tukey_hsd(formula = EC ~ Covercrop + WheatM)
print(res_tukey[res_tukey$p.adj<0.06,])

```

Split by treatment
```{r}
#just ran and swtiched the response variable instaed of recoding or loopoing. I'm being lazy and want to get this done.
#checked res noramlity by chaing respone 
md<-data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+W")))
md <- md %>% filter(NitrateNperkgDrySoil > 0)


#residual tests
mod<- aov(log(NH4NperkgDrySoil) ~ Timepoint, data = md)
shapiro_test(mod$residuals)
hist(mod$residuals)

mod<- aov(log(NitrateNperkgDrySoil) ~ Timepoint, data = md)
shapiro_test(mod$residuals)
hist(mod$residuals)

boxplot(md$NitrateNperkgDrySoil ~ md$Timepoint)



res_aov <- md %>% anova_test(pH ~ Timepoint)
print(res_aov)

res_aov <- md %>% anova_test(EC ~ Timepoint)
print(res_aov)

res_aov <- md %>% anova_test(log(NH4NperkgDrySoil) ~ Timepoint)
print(res_aov)

res_aov <- md %>% anova_test(log(NitrateNperkgDrySoil) ~ Timepoint)
print(res_aov)
      
res_tukey <- md %>% tukey_hsd(formula = log(NH4NperkgDrySoil) ~ Timepoint)
print(res_tukey[res_tukey$p.adj<0.06,])
```


Alpha diversity over time 
```{r}
alphadiv<-estimate_richness(ps16S_bac_rarefy_iter)
alphadiv$treatment <- sample_data(ps16S_bac_rarefy_iter)$Treatment
alphadiv$covercrop <- sample_data(ps16S_bac_rarefy_iter)$Covercrop
alphadiv$time <- as.factor(sample_data(ps16S_bac_rarefy_iter)$time)
alphadiv$wheatm <- sample_data(ps16S_bac_rarefy_iter)$WheatM
alphadiv$pH <- sample_data(ps16S_bac_rarefy_iter)$pH

plot(alphadiv$Shannon ~ alphadiv$wheatm)

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Observed, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Observed, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Shannon, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Shannon, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Simpson, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Simpson, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")


#Shannon    
res_aov <- alphadiv %>% anova_test(Shannon ~ covercrop + wheatm + time )
    print(res_aov)
res_tukey <- alphadiv %>% tukey_hsd(formula = Shannon ~ time)
          print(res_tukey)    
      plot(alphadiv$Shannon ~ alphadiv$time)    
    
#observed
res_aov <- alphadiv %>% anova_test(Observed ~ covercrop + wheatm + time )
    print(res_aov)
    
  res_tukey <- alphadiv %>% tukey_hsd(formula = Observed ~ time)
          print(res_tukey)    
plot(alphadiv$Observed ~ alphadiv$time)
  


for (i in 1:length(unique(alphadiv$time))){
  print(unique(alphadiv$time)[i])
    
    res_aov <- alphadiv %>% filter(time == unique(alphadiv$time)[i]) %>% anova_test(Shannon ~ covercrop + wheatm, )
    print(res_aov)
          
          res_tukey <- alphadiv %>% filter(time == unique(alphadiv$time)[i])%>% tukey_hsd(formula = Shannon ~ treatment)
          print(res_tukey)
              
                    res_tukey <- res_tukey %>% add_xy_position(x="Treatment")
                    
                    plot1 <-  alphadiv %>% filter(time == unique(alphadiv$time)[i]) %>% ggboxplot(x = "treatment", y = "Observed") +
                    stat_pvalue_manual(res_tukey, hide.ns = T) + labs(subtitle = get_test_label(res_aov, detailed = T), caption = get_pwc_label(res_tukey))
                    print(plot1)
}
    
    
    
for (i in 1:length(unique(alphadiv$covercrop))){
  print(unique(alphadiv$covercrop)[i])
    
    res_aov <- alphadiv %>% filter(covercrop == unique(alphadiv$covercrop)[i]) %>% anova_test(Shannon ~ time )
    print(res_aov)
          
          res_tukey <- alphadiv %>% filter(covercrop == unique(alphadiv$covercrop)[i]) %>% tukey_hsd(formula = Shannon ~ time)
          print(res_tukey)
              
                    res_tukey <- res_tukey %>% add_xy_position(x="Treatment")
                    
                    plot1 <-  alphadiv %>% filter(covercrop == unique(alphadiv$covercrop)[i]) %>% ggboxplot(x = "covercrop", y = "Shannon") +
                    stat_pvalue_manual(res_tukey, hide.ns = T) + labs(subtitle = get_test_label(res_aov, detailed = T), caption = get_pwc_label(res_tukey))
                    print(plot1)
  }

```


Beta diversity
global

```{r}

com_ord <- ordinate(ps16S_bac_rarefy_iter, method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(ps16S_bac_rarefy_iter)$pH
com_df_nmds$EC <- sample_data(ps16S_bac_rarefy_iter)$EC
com_df_nmds$NitrateN <- sample_data(ps16S_bac_rarefy_iter)$NitrateN
com_df_nmds$timepoint <- sample_data(ps16S_bac_rarefy_iter)$Timepoint
com_df_nmds$treatment<- sample_data(ps16S_bac_rarefy_iter)$Treatment
com_df_nmds$covercrop <- sample_data(ps16S_bac_rarefy_iter)$Covercrop
com_df_nmds$wheatm <- sample_data(ps16S_bac_rarefy_iter)$WheatM
com_df_nmds$time <- sample_data(ps16S_bac_rarefy_iter)$time
#plot nmds 
plot(com_df_nmds$MDS1 ~ com_df_nmds$pH)
ggplot(com_df_nmds, aes(x = MDS1, y = pH, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 


#axis 1 with pH
summary(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH))
hist(residuals(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH)))
#looks normal enough, but just in case heres a non-parametric regression
summary(lm(MDS1 ~ pH, data = com_df_nmds))
#summary(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH, dataframe = com_df_nmds))
```

```{r}

com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")


ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + Timepoint + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 100)
}
ps_adonis(ps16S_bac_rarefy_iter)


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Timepoint, p.adjust.m = "fdr", perm = 1000))

}

ps_pairwiseadonis(ps16S_bac_rarefy_iter)


```
split by timepoint



day 0
```{r}
#com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))



ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))

```

Day 2
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))

```

Day 5
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t2"))

```

day 7
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))

```

day 14
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))

```

day 21
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))

```

day 64
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$time
#plot nmds with colors etc 
 
#ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  Covercrop + WheatM + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 1000))
}

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))

```

#split by cover crop

```{r}
#com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")


ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Timepoint)))
  vegan::adonis2(physeq_dist ~ Timepoint + pH + EC + NitrateNperkgDrySoil + NH4NperkgDrySoil, data = md_tab, permutations = 1000)
}

ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
#print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 1000))
#print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 1000))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Timepoint, p.adjust.m = "fdr", perm = 1000))
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+W"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+W"))


ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+WM"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+WM"))


ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC"))


ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC+WM"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC+WM"))

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr"))

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr+WM"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr+WM"))

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp"))

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp+WM"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp+WM"))
```

#eco resillience
```{r}
plotDistances = function(p, m, s, d) {
  
  #p phyloaeq
  #m distance metric
  # s sample id column
  # treatment group

 #p= subset_samples(ps16S_bac_rarefy_iter, WheatM == "WM")
 #  p=ps16S_bac_rarefy_iter
#    m = "bray"
#     s = "sample.names"
#      d = "Covercrop"
  
  # calc distances
  wu = phyloseq::distance(p, m)
  wu.m = melt(as.matrix(wu))
  
  # remove self-comparisons
  wu.m = wu.m %>%
    filter(as.character(Var1) != as.character(Var2)) %>%
    mutate_if(is.factor,as.character)
  
  # get sample data (S4 error OK and expected)
  sd = data.frame(sample_data(p)) %>%
    dplyr::select(s, d, WheatM, time) %>%
    mutate_if(is.factor,as.character)
  sd$Covercrop <- factor(sd$Covercrop, levels = c("NoCC", "Tr", "CC", "2Spp"))
 # sd$Timepoint <- factor(sd$Timepoint, levels = c("to", "t1", "t2", "t3", "t4", "t5", "t6"))
  # combined distances with sample data
  colnames(sd) = c("Var1", "Type1", "WheatM", "time")
  
  wu.sd = left_join(wu.m, sd, by = "Var1")
  
  colnames(sd) = c("Var2", "Type2", "WheatM", "time")
  wu.sd = left_join(wu.sd, sd, by = "Var2")
  
  #keep only comparisons within single cover crop type
  wu.sd_test <- wu.sd[wu.sd$Type1 == wu.sd$Type2,]
  
  #extract time points from sample name
  wu.sd_test$Timeval1 <- str_split(string = wu.sd_test$Var1, "-", n = 5, simplify = T)[,2]
  wu.sd_test$Timeval2 <- str_split(string = wu.sd_test$Var2, "-", n = 5, simplify = T)[,2]
  
  #keep only those comparing to time 0
    wu.sd_test <- wu.sd_test[wu.sd_test$Timeval2 == "t0",]

    
    #simplify the names of the wu.sd.test
  wu.sd_test_plotting <- wu.sd_test %>% dplyr::select(Var1, Var2, value, Type1, WheatM.x, time.x, Type2, Timeval1, Timeval2)
  wu.sd_test_plotting$time <- wu.sd_test_plotting$time.x
  wu.sd_test_plotting$time.x = NULL
   wu.sd_test_plotting$WheatM <- wu.sd_test_plotting$WheatM.x
   wu.sd_test_plotting$WheatM.x = NULL
   
   wu.sd_test_plotting$WheatM <-as.factor(wu.sd_test_plotting$WheatM )
  
  #remove this line to plot all comparisons. 
  #wu.sd = wu.sd %>% filter(Type1 == "Hand" | Type1 == "Non-Treated")
  
   
   #remove this line if you want to make the plot. By running this, the function only returns the dataframe of distances. 
   return(wu.sd_test_plotting)
   
dat_res <- wu.sd_test_plotting %>% filter(Timeval1 == "t7") 
print(dat_res)
mod_res<-aov(value ~ Type1*WheatM, data = dat_res)
print(summary(mod_res))
print(TukeyHSD(mod_res, which = "Type1"))
print(TukeyHSD(mod_res, which = "WheatM"))
   
  # plot
  ggplot(wu.sd_test_plotting, aes(x = Timeval1, y = value)) +
    theme_bw() +
  #geom_point() +
   # geom_boxplot(aes(color = ifelse(Type1 == Type2, "red", "black"))) +
    geom_boxplot(aes(x = Timeval1, y = value, fill = WheatM)) +
    scale_color_identity() +
    #facet_wrap(~ Type1*WheatM, scales = "free_x", ncol = 2) +
    facet_wrap(~ Type1, scales = "free_x", ncol = 2) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1, size = 5)) + 
    ggtitle(paste0("Distance Metric = ", m)) + geom_smooth(data = wu.sd_test_plotting, aes(group=WheatM,),  se= T, method = "loess") 

                                                           
}
```

```{r}
a<-plotDistances(p = subset_samples(physeq= ps16S_bac_rarefy_iter, WheatM == "WM"), m = "bray", s = "sample.names", d = "Covercrop")
a <- a + ggtitle("Time 1 Bray-Curtis Dissimlarities with WM")
a

b<-plotDistances(p = subset_samples(physeq= ps16S_bac_rarefy_iter, WheatM == "NoWM"), m = "bray", s = "sample.names", d = "Covercrop")
b <- b + ggtitle("Time 1 Bray-Curtis Dissimlarities No WM")
b

c <-plotDistances(p = ps16S_bac_rarefy_iter, m = "bray", s = "sample.names", d = "Covercrop")
c <- c + ggtitle("Time 1 Bray-Curtis Dissimlarities")
c



dists <-plotDistances(p = ps16S_bac_rarefy_iter, m = "bray", s = "sample.names", d = "Covercrop")
dists %>% filter(Timeval1 == "t7") %>% group_by(Type1, WheatM) %>% summarize(mean = mean(value), stdev = sd(value)) %>% mutate(std_devCI = 1.96*stdev) %>% mutate(low = mean-std_devCI, high = mean+std_devCI) 


```










```{r}
library(usedist)
#FW
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+W")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+W")))
bd<-vegan::betadisper(dist, md_tab$Timepoint)
bd$distances
with(bd, boxplot(distances~group))
anova(bd)
TukeyHSD(bd)


dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t1"))
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t1"), idx2 = which(md_tab$Timepoint == "t2"))
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t2"), idx2 = which(md_tab$Timepoint == "t3"))
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t3"), idx2 = which(md_tab$Timepoint == "t4"))
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t4"), idx2 = which(md_tab$Timepoint == "t5"))
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t5"), idx2 = which(md_tab$Timepoint == "t6"))
#dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t6"), idx2 = which(md_tab$Timepoint == "t7"))



#F+WM
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+WM")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+WM")))
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))


#CC
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC")))
#md_tab$Timepoint <- md_tab$Timepoint
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))

#CC+WM
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC+WM")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC+WM")))
#md_tab$Timepoint <- md_tab$Timepoint
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))

#Tr
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr")))
#md_tab$Timepoint <- md_tab$Timepoint
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))

#Tr+WM
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr+WM")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr+WM")))
#md_tab$Timepoint <- md_tab$Timepoint
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))

#2spp
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp")))
#md_tab$Timepoint <- md_tab$Timepoint
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))
                       
                       
#2spp + WM
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp+WM")))
dist <-parallelDist::parDist(dat, method = "bray")
md_tab<-data.frame(phyloseq::sample_data(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp+WM")))
#md_tab$Timepoint <- md_tab$Timepoint
bd<-vegan::betadisper(dist, md_tab$Timepoint)
anova(bd)
TukeyHSD(bd)
dist_between_centroids(dist, idx1 = which(md_tab$Timepoint == "t0"), idx2 = which(md_tab$Timepoint == "t6"))

```


```{r}
#EXTRACT DATA AND CREATE DISTANCE MATRIX
dat <- as.matrix(otu_table(subset_samples(ps16S_bac_rarefy_iter)))
md_tab<-data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter)))
dist <-parallelDist::parDist(dat, method = "bray")
md_list <- md_tab$Timepoint
#CALCULATE DISTANCE BETWEEN SAMPLES 
dist_bt_groups<-dist_groups(dist, md_list)

#FILTER TO ONLY INCLUDE BETWEEN SAMPLE COMPARISONS. 
dist_bt_groups_filtered <-dist_bt_groups %>% filter(Label != "Within t0" & Label != "Within t1" & Label != "Within t2" & Label != "Within t3" & Label != "Within t4" & Label != "Within t5" & Label != "Within t6")

#FILTER TO ONLY INCLUDE 1 TP TO THE NEXT (EG 0>1, 1>2, 2>3 ETC)
dist_bt_groups_filtered_2 <- dist_bt_groups_filtered %>% filter(Label == "Between t0 and t1" | Label == "Between t1 and t2"| Label == "Between t2 and t3" | Label == "Between t3 and t4" | Label == "Between t4 and t5" | Label == "Between t5 and t6")


#MATCH FIRST SAMPLE TO METADAT TO EXTRACT TREATMENT
dist_bt_groups_filtered_2$Trt1 <- 'NA'
for (i in 1:nrow(dist_bt_groups_filtered_2)){
  for(j in 1:nrow(md_tab)){
      if(dist_bt_groups_filtered_2[i,]$Item1==md_tab[j,]$sample.names){
        dist_bt_groups_filtered_2[i,]$Trt1 <- as.character(md_tab[j,]$Treatment)
      }
    else{}
  }
}

#MATCH SECOND SAMPLE TO METADAT TO EXTRACT TREATMENT
dist_bt_groups_filtered_2$Trt2 <- 'NA'
for (i in 1:nrow(dist_bt_groups_filtered_2)){
  for(j in 1:nrow(md_tab)){
      if(dist_bt_groups_filtered_2[i,]$Item2==md_tab[j,]$sample.names){
        dist_bt_groups_filtered_2[i,]$Trt2 <- as.character(md_tab[j,]$Treatment)
      }
    else{}
  }
}

#FILTER TO ONLY INCLUDE COMPARISONS WITHIN A TREATMENT GROUP
dist_bt_groups_filtered_2_matched <- dist_bt_groups_filtered_2 %>% filter(Trt1 == Trt2)

ggplot(data = dist_bt_groups_filtered_2_matched) + geom_boxplot(mapping = aes(x = Label, y = Distance, fill = Trt1)) + facet_wrap(~Trt1) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  + geom_smooth(data = dist_bt_groups_filtered_2_matched, aes(x = Label, y = Distance, group=Trt1,),  se= T, method = "loess")




dist_bt_groups_filtered_3 <- dist_bt_groups_filtered %>% filter(Label == "Between t0 and t6")


#MATCH FIRST SAMPLE TO METADAT TO EXTRACT TREATMENT
dist_bt_groups_filtered_3$Trt1 <- 'NA'
for (i in 1:nrow(dist_bt_groups_filtered_3)){
  for(j in 1:nrow(md_tab)){
      if(dist_bt_groups_filtered_3[i,]$Item1==md_tab[j,]$sample.names){
        dist_bt_groups_filtered_3[i,]$Trt1 <- as.character(md_tab[j,]$Treatment)
      }
    else{}
  }
}

#MATCH SECOND SAMPLE TO METADAT TO EXTRACT TREATMENT
dist_bt_groups_filtered_3$Trt2 <- 'NA'
for (i in 1:nrow(dist_bt_groups_filtered_3)){
  for(j in 1:nrow(md_tab)){
      if(dist_bt_groups_filtered_3[i,]$Item2==md_tab[j,]$sample.names){
        dist_bt_groups_filtered_3[i,]$Trt2 <- as.character(md_tab[j,]$Treatment)
      }
    else{}
  }
}


#FILTER TO ONLY INCLUDE COMPARISONS WITHIN A TREATMENT GROUP
dist_bt_groups_filtered_3_matched <- dist_bt_groups_filtered_3 %>% filter(Trt1 == Trt2)

ggplot(data = dist_bt_groups_filtered_3_matched) + geom_boxplot(mapping = aes(x = Label, y = Distance, fill = Trt1)) + facet_wrap(~Trt1) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  
```

























edaphic over time (without 55 dap point)
```{#r}
md <- data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6")))
#ph with regression
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = pH, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = pH, color = Treatment, group = time)) + facet_wrap("Treatment")

#EC with regression
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = EC, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = EC, color = Treatment, group = time)) + facet_wrap("Treatment")

#nitrate with regression
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateNperkgDrySoil, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = NitrateNperkgDrySoil, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = NitrateNperkgDrySoil, color = Treatment, group = time)) + facet_wrap("Treatment")

#ammonium with regression
ggplot(md) + geom_boxplot(aes(x = time, y = NH4NperkgDrySoil, color = Treatment, group = time)) + geom_smooth( data = md, aes(x=time, y = NH4NperkgDrySoil, group = "Treatment"), method = "lm", se = F) + facet_wrap("Treatment")
#without regression line
ggplot(md) + geom_boxplot(aes(x = time, y = NH4NperkgDrySoil, color = Treatment, group = time)) + facet_wrap("Treatment")


#non-parametric regression
#Ph
for (i in 1:length(unique(md$Treatment))){
  print(unique(md$Treatment[i]))
  md %>% filter(Treatment == unique(md$Treatment[i])) %>% mblm(pH ~ time, data = .) %>% summary() %>% print() 
}

#EC
for (i in 1:length(unique(md$Treatment))){
  print(unique(md$Treatment[i]))
  md %>% filter(Treatment == unique(md$Treatment[i])) %>% mblm(EC ~ time, data = .) %>% summary() %>% print() 
}
#nitrate
for (i in 1:length(unique(md$Treatment))){
  print(unique(md$Treatment[i]))
  md %>% filter(Treatment == unique(md$Treatment[i])) %>% mblm(NitrateNperkgDrySoil ~ time, data = .) %>% summary() %>% print() 
}
#ammonium
for (i in 1:length(unique(md$Treatment))){
  print(unique(md$Treatment[i]))
  md %>% filter(Treatment == unique(md$Treatment[i])) %>% mblm(NH4NperkgDrySoil ~ time, data = .) %>% summary() %>% print() 
}
```


ordination of edaphic conditions (without 55 dap point)
```{#r}
#switch md to either include or exclude t 55 days
md <- data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6")))
#md <- data.frame(sample_data(ps16S_bac_rarefy_iter)

#standardize edaphic conditions

md_heatmap <- md %>% select(time, Treatment, pH, EC, NitrateN, AmmoniumN) %>% filter(time != 0)
md_heatmap[,3:6] <- scale(md_heatmap[,3:6],center = T, scale = T)
ord <- metaMDS(md_heatmap[,3:6], distance = "euclidian" , data = md_heatmap[,3:6])

plot(ord, display = "sites")

dune.fit <- envfit(ord ~ pH + EC + NitrateN + AmmoniumN, md_heatmap[,3:6], 
                   choices=c(1:2)) 
dune.fit

#base R plot
plot(ord, display = "sites", type = "n")
points(ord, display = "sites", col = "black", cex = 1.25)
plot(dune.fit)

spp.scrs <- as.data.frame(scores(dune.fit, display = "vectors"))
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs))

df <-data.frame(ord$points)
df$time <- md_heatmap$time
df$treatment <- md_heatmap$Treatment
df$pH <- md_heatmap$pH
  ggplot(data=df, aes(x=MDS1, y=MDS2)) + theme_bw(16) + 
            labs(x="MDS Axis 1",y="MDS Axis 2") +
            theme(panel.grid=element_blank()) + geom_point(aes(shape=as.factor(time), color = treatment), size = 7) +
  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = spp.scrs,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  geom_text(data = spp.scrs, aes(x = NMDS1, y = NMDS2, label = Species),
            size = 3)
  
md_dist <- dist(md[,c("pH", "EC", "NitrateNperkgDrySoil", "NH4NperkgDrySoil")], method = "euclidean")
adonis2(md_dist~ Covercrop + WheatM + Timepoint, data = md, strata = md$Timepoint)
#pairwiseAdonis::pairwise.adonis2(md_dist ~ Treatment, data = md, strata = md$Timepoint)
```
heat map of edaphic conditions
```{r}
#switch md to either include or exclude t 55 days
#md <- data.frame(sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6")))
md <- data.frame(sample_data(ps16S_bac_rarefy_iter))

md_heatmap <- md %>% select(time, Treatment, pH, EC, NitrateN, AmmoniumN) %>% filter(time != 0)
#to remove time 0 if we look at nitrate and ammonia values bc they are missing at t0
#md_heatmap <- md %>% select(time, Treatment, pH, EC, NitrateNperkgDrySoil, NH4NperkgDrySoil) %>% filter(time != 0)

#standardize
md_heatmap[,3:6] <- scale(md_heatmap[,3:6],center = T, scale = T)

heatmap(as.matrix(md_heatmap[3:6]), scale = "column", Colv = NA, Rowv = NA)
```


#Community data

#Alpha Diversity
Alpha diversity over time (with 55 dap point)
```{#r}
alphadiv<-estimate_richness(ps16S_bac_rarefy_iter)
alphadiv$treatment <- sample_data(ps16S_bac_rarefy_iter)$Treatment
alphadiv$time <- sample_data(ps16S_bac_rarefy_iter)$time
alphadiv$wheatm <- sample_data(ps16S_bac_rarefy_iter)$WheatM
alphadiv$pH <- sample_data(ps16S_bac_rarefy_iter)$pH

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Observed, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Observed, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

#lm but wont meet requirements of lm
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% lm(Observed ~ time, data = .) %>% summary() %>% print() %>% residuals() %>% hist()
}

#non-parametric regression
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% mblm(Observed ~ time, data = .) %>% summary() %>% print() 
}

```

Alpha diversity over time 
```{r}
#without 55 days after planting point
alphadiv<-estimate_richness(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))
alphadiv$treatment <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Treatment
alphadiv$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$time
alphadiv$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$WheatM
alphadiv$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$pH

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Observed, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Observed, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Shannon, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Shannon, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

ggplot(alphadiv) + geom_boxplot(aes(x = time, y = Simpson, color = treatment, group = time)) + geom_smooth( data = alphadiv, aes(x=time, y = Simpson, group = "treatment"), method = "lm", se = F) + facet_wrap("treatment")

#lm but wont meet requirements of lm
#for (i in 1:length(unique(alphadiv$treatment))){
#  print(unique(alphadiv$treatment[i]))
#  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% lm(Observed ~ time, data = .) %>% summary() %>% print() %>% residuals() %>% hist()
#}

#non-parametric regression
for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% mblm(Observed ~ time, data = .) %>% summary() %>% print() 
}

for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% mblm(Shannon ~ time, data = .) %>% summary() %>% print() 
}

for (i in 1:length(unique(alphadiv$treatment))){
  print(unique(alphadiv$treatment[i]))
  alphadiv %>% filter(treatment == unique(alphadiv$treatment[i])) %>% mblm(Simpson ~ time, data = .) %>% summary() %>% print() 
}


```

#beta-diversity
(without 55 dap point)
```{r}

com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"), method = "NMDS", distance = "bray", k = 3)
ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$EC
com_df_nmds$NitrateN <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$NitrateN
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))$time
#plot nmds 
plot(com_df_nmds$MDS1 ~ com_df_nmds$pH)
ggplot(com_df_nmds, aes(x = MDS1, y = pH, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 


#axis 1 with pH
summary(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH))
hist(residuals(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH)))
#looks normal enough, but just in case heres a non-parametric regression
summary(mblm(MDS1 ~ pH, dataframe = com_df_nmds))
#summary(lm(com_df_nmds$MDS1 ~ com_df_nmds$pH, dataframe = com_df_nmds))
```
global adonis testing
```{r}
ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM + Covercrop + Timepoint, data = md_tab, permutations = 100)
}
ps_adonis(ps16S_bac_rarefy_iter)

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))


ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 100))

}

ps_pairwiseadonis(ps16S_bac_rarefy_iter)
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint != "t6"))

```

#split a few time points and see trends

index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")

day 0
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM * Covercrop, data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))



ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t0"))

```

day 2
index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~  pH + WheatM * Covercrop , data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))


ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t1"))

```

day 7
index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM * Covercrop , data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t3"))
```


day 14
index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM * Covercrop, data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t4"))
```

index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = wheatm, alpha=pH)) + geom_point(aes(size=7)) + theme_classic() + scale_color_manual(values = col_vector)

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM * Covercrop , data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t5"))
```

index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")

after planting (55 dat)
```{r}
com_ord <- ordinate(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"), method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$pH
com_df_nmds$EC <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$EC
com_df_nmds$pH <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$pH
com_df_nmds$timepoint <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$Timepoint
com_df_nmds$treatment<- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$Treatment
com_df_nmds$covercrop <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$Covercrop
com_df_nmds$wheatm <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$WheatM
com_df_nmds$time <- sample_data(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = wheatm, alpha=pH)) + geom_point(aes(size=7)) + theme_classic() + scale_color_manual(values = col_vector)

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM * Covercrop , data = md_tab, permutations = 100)
}

ps_adonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Timepoint == "t6"))
```
Compare t0 and t5 to see if treatments result in deviation
```{r}
ps_subset <- ps16S_bac_rarefy_iter %>% subset_samples(Timepoint != "t1") %>% subset_samples(Timepoint != "t2") %>% subset_samples(Timepoint != "t3") %>% subset_samples(Timepoint != "t4") %>% subset_samples(Timepoint != "t6")
sample_data(ps_subset)

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM + Covercrop + Timepoint, data = md_tab, permutations = 100)
} 

ps_adonis(ps_subset)

ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Timepoint, p.adjust.m = "fdr", perm = 100))
}

ps_pairwiseadonis(ps_subset)

com_ord <- ordinate(ps_subset, method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(ps_subset)$pH
com_df_nmds$EC <- sample_data(ps_subset)$EC
com_df_nmds$pH <- sample_data(ps_subset)$pH
com_df_nmds$timepoint <- sample_data(ps_subset)$Timepoint
com_df_nmds$treatment<- sample_data(ps_subset)$Treatment
com_df_nmds$covercrop <- sample_data(ps_subset)$Covercrop
com_df_nmds$wheatm <- sample_data(ps_subset)$WheatM
com_df_nmds$time <- sample_data(ps_subset)$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint)) + geom_point(aes(size=7)) + theme_classic() + scale_color_manual(values = col_vector)
```

Compare t0 and t6 to see if treatments result in legacy effect
```{r}
ps_subset <- ps16S_bac_rarefy_iter %>% subset_samples(Timepoint != "t1") %>% subset_samples(Timepoint != "t2") %>% subset_samples(Timepoint != "t3") %>% subset_samples(Timepoint != "t4") %>% subset_samples(Timepoint != "t5")
sample_data(ps_subset)

ps_adonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
  print(anova(vegan::betadisper(physeq_dist, md_tab$Treatment)))
  vegan::adonis2(physeq_dist ~ pH + WheatM + Covercrop + Timepoint, data = md_tab, permutations = 100)
} 

ps_adonis(ps_subset)

ps_pairwiseadonis<-function(physeq){
  otu_tab<-data.frame(phyloseq::otu_table(physeq))
  md_tab<-data.frame(phyloseq::sample_data(physeq))
    if(taxa_are_rows(physeq)== T){
       physeq_dist<-parallelDist::parDist(as.matrix(t(otu_tab)), method = "bray")}
            else{physeq_dist<-parallelDist::parDist(as.matrix(otu_tab), method = "bray")}
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Treatment, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$WheatM, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Covercrop, p.adjust.m = "fdr", perm = 100))
print(pairwiseAdonis::pairwise.adonis(x = physeq_dist, factors = md_tab$Timepoint, p.adjust.m = "fdr", perm = 100))
}

ps_pairwiseadonis(ps_subset)

com_ord <- ordinate(ps_subset, method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(ps_subset)$pH
com_df_nmds$EC <- sample_data(ps_subset)$EC
com_df_nmds$pH <- sample_data(ps_subset)$pH
com_df_nmds$timepoint <- sample_data(ps_subset)$Timepoint
com_df_nmds$treatment<- sample_data(ps_subset)$Treatment
com_df_nmds$covercrop <- sample_data(ps_subset)$Covercrop
com_df_nmds$wheatm <- sample_data(ps_subset)$WheatM
com_df_nmds$time <- sample_data(ps_subset)$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint)) + geom_point(aes(size=7)) + theme_classic() + scale_color_manual(values = col_vector)
```



Pairwise adonis testing and then plotting of timpeoints within a treatment 
```{r}
#split by treatment and examine pre and post treatments
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "2spp+WM"))


ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "CC+WM"))

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+W"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "F+WM"))

ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr"))
ps_pairwiseadonis(subset_samples(ps16S_bac_rarefy_iter, Treatment == "Tr+WM"))


```

Timepoints across treatment groups
index <- c("t0", "t1", "t2", "t3", "t4", "t5", "t6")
values <- c("0", "2", "5", "7", "14", "21", "55")
```{r}
ps_subset <- ps16S_bac_rarefy_iter %>% subset_samples(Timepoint =! "t1") %>% subset_samples(Timepoint != "t2") %>% subset_samples(Timepoint != "t3") %>% subset_samples(Timepoint != "t4")


com_ord <- ordinate(ps_subset, method = "NMDS", distance = "bray", k = 3)
#ord_plot<-plot_ordination(ps16S_bac_rarefy_iter, ordination = com_ord, type = "samples", axes = 1:2, color = "Treatment", shape = "Timepoint")

com_df_nmds<-data.frame(com_ord$points)
com_df_nmds$pH <- sample_data(ps_subset)$pH
com_df_nmds$EC <- sample_data(ps_subset)$EC
com_df_nmds$pH <- sample_data(ps_subset)$pH
com_df_nmds$timepoint <- sample_data(ps_subset)$Timepoint
com_df_nmds$treatment<- sample_data(ps_subset)$Treatment
com_df_nmds$covercrop <- sample_data(ps_subset)$Covercrop
com_df_nmds$wheatm <- sample_data(ps_subset)$WheatM
com_df_nmds$time <- sample_data(ps_subset)$time
#plot nmds with colors etc 
 
ggplot(com_df_nmds, aes(x = MDS1, y = MDS2, color = treatment, shape = timepoint, alpha = pH)) + geom_point(aes(size=7)) + theme_classic() 
```


#corncob regression models
```{r}
#remotes::install_github("statdivlab/corncob")
require(corncob)
```

CORNCOB regression
subset samples to high and low nitrogen and condense at order level for this initial pass. 
```{#r}
cc_ps<- ps16S_bac_rarefy_iter %>% tax_glom("Phylum")
#350 genera left to model
```

alter plotting function to color bars that do not overlap 0
```{r}
plot.differentialTest2 <- function(x, level = NULL, data_only = FALSE, ...) {
  signif_taxa <- x$significant_taxa
  if ("phyloseq" %in% class(x$data)) {
    if (!is.null(x$data@tax_table)) {
      signif_taxa <- otu_to_taxonomy(signif_taxa, x$data, level = level)
      if (length(unique(signif_taxa)) != length(unique(x$significant_taxa))) {
        # Make sure if repeated taxa add unique otu identifiers
        signif_taxa <- paste0(signif_taxa, " (", x$significant_taxa, ")")
      }
    }
  }
  if (length(x$significant_models) != 0) {
    var_per_mod <- length(x$restrictions_DA) + length(x$restrictions_DV)
    total_var_count <- length(signif_taxa) * var_per_mod
    df <- as.data.frame(matrix(NA, nrow = total_var_count, ncol = 5))
    colnames(df) <- c("x", "xmin", "xmax", "taxa", "variable")
    qval <- stats::qnorm(.975)
    restricts_mu <- attr(x$restrictions_DA, "index")
    restricts_phi <- attr(x$restrictions_DV, "index")

    count <- 1
    for (i in 1:length(x$significant_models)) {

      # Below from print_summary_bbdml, just to get coefficient names
      tmp <- x$significant_models[[i]]
      coefs.mu <- tmp$coefficients[1:tmp$np.mu,, drop = FALSE]
      rownames(coefs.mu) <- paste0(substring(rownames(coefs.mu), 4), "\nDifferential Abundance")
      coefs.mu <- coefs.mu[restricts_mu,, drop = FALSE]

      coefs.phi <- tmp$coefficients[(tmp$np.mu + 1):nrow(tmp$coefficients),, drop = FALSE]
      rownames(coefs.phi) <- paste0(substring(rownames(coefs.phi), 5), "\nDifferential Variability")
      coefs.phi <- coefs.phi[restricts_phi - tmp$np.mu,, drop = FALSE]

      coefs <- rbind(coefs.mu, coefs.phi)
      for (j in 1:var_per_mod) {
        df[count, 1:3] <- c(coefs[j, 1], coefs[j, 1] - qval * coefs[j, 2],
                        coefs[j, 1] + qval * coefs[j, 2])
        df[count, 4:5] <- c(signif_taxa[i], rownames(coefs)[j])
        count <- count + 1
      }
    }
    if (!(data_only)) {
    # global variables warning suppression
    taxa <- xmin <- xmax <- NULL
    df <- df[order(df$taxa),]
    ggplot2::ggplot(df, ggplot2::aes(x = x, y = taxa)) +
      ggplot2::geom_vline(xintercept = 0, color = "gray50", lty = "dashed",
                          alpha = 0.75, lwd = 1) +
      ggplot2::geom_point() +
      ggplot2::geom_errorbarh(ggplot2::aes(xmin = xmin, xmax = xmax, colour = xmin<=0 & xmax <= 0| xmin>=0 & xmax >= 0), height = .3) +
      ggplot2::theme_bw() +
      ggplot2::facet_wrap(~variable, scales = "free_x", nrow = 1) +
      ggplot2::labs(title = "", x = "", y = "Taxa") +
      ggplot2::scale_y_discrete(limits = rev(df$taxa)) +
      ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +
      ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))+
      ggplot2::theme(legend.position = "none")
    } else {
    return(df)
  }
  } else {
    message("No taxa were found to be significantly different using your model specification. \nPlease verify that your formulas are correctly specified.")
  }
}
```

from B.Martin's git page on interpreting effect sizes. 

"Not exactly, because it is not a linear model. By default, corncob uses the logit link between the expected relative abundance and the covariates. This can be interpreted on the log-odds scale, similar to with logistic regression. Typically, I recommend users interpret parameters directly on the logit scale, for example "The expected difference in the logit-transformed relative abundance between two samples that differ by one unit change in [my covariate] controlling for [all controls] is [coefficient value]"

"The difference between the formulas and the null version of the formulas are the variables that we test. We will go through several examples, starting with a test for differential abundance across the DayAmdmt coefficient."

explanations of model specificaiton can be found in examples at end of the vignette. 
https://cran.r-project.org/web/packages/corncob/vignettes/corncob-intro.html

Run model at genus level. 
 
```{r}
#cc_ps<- ps16S_bac_rarefy_iter %>% tax_glom("Genus") %>% subset_samples(Timepoint != "t6")
cc_ps<- ps16S_bac_rarefy_iter %>% tax_glom("Phylum") 
set.seed(1)
#Testing for taxa that significantly respond to Nitrogen, pH, and POA2021 cover, while controlling for POA2021 cover on dispersion.
#da_analysis <- differentialTest(formula = ~ X2021.Spring.Poa.. + Nitrogen + pH, phi.formula = ~  X2021.Spring.Poa.., formula_null = ~ 1, phi.formula_null = ~  X2021.Spring.Poa.., test = "Wald", boot = FALSE, data = turf16S_cc_rarefy, fdr_cutoff = 0.05)
da_analysis <- differentialTest(formula = ~  pH, phi.formula = ~   pH, formula_null = ~ 1, phi.formula_null = ~ pH, test = "Wald", boot = FALSE, data = cc_ps, fdr_cutoff = 0.05)

summary(da_analysis)
da_analysis$significant_taxa
da_analysis$significant_models
otu_to_taxonomy(OTU=da_analysis$significant_taxa,data=ps16S_bac_rarefy_iter)

plot.differentialTest2(da_analysis, level= c("Phylum","Order", "Family", "Genus"))

plot.differentialTest2(da_analysis, level= c("Family"))
```

#abudnance of specific groups
```{r}
require(microbiome)
require(tidyverse)
cc_ps <- ps16S_bac_rarefy_iter %>% tax_glom("Phylum")
boxplot_abundance(cc_ps, x = "Timepoint", y = "ASV3" )
boxplot_abundance(cc_ps, x = "pH", y = "ASV3" )
summary(lm(data.frame(otu_table(cc_ps))$ASV3 ~ data.frame(sample_data(cc_ps))$pH))

```

## beta boxplots throuhg time compared to control
not working, old implementation
```{r}
plotDistances = function(p, m, s, d) {

 #p= subset_samples(ps16S_bac_rarefy_iter, WheatM == "WM")
  # p=ps16S_bac_rarefy_iter
  # m = "bray"
  # s = "sample.names"
  # d = "Covercrop"
  
  # calc distances
  wu = phyloseq::distance(p, m)
  wu.m = melt(as.matrix(wu))
  
  # remove self-comparisons
  wu.m = wu.m %>%
    filter(as.character(Var1) != as.character(Var2)) %>%
    mutate_if(is.factor,as.character)
  
  # get sample data (S4 error OK and expected)
  sd = data.frame(sample_data(p)) %>%
    select(s, d, WheatM) %>%
    mutate_if(is.factor,as.character)
  sd$Covercrop <- factor(sd$Covercrop, levels = c("NoCC", "Tr", "CC", "2Spp"))
 # sd$Timepoint <- factor(sd$Timepoint, levels = c("to", "t1", "t2", "t3", "t4", "t5", "t6"))
  # combined distances with sample data
  colnames(sd) = c("Var1", "Type1", "WheatM")
  
  wu.sd = left_join(wu.m, sd, by = "Var1")
  
  colnames(sd) = c("Var2", "Type2", "WheatM")
  wu.sd = left_join(wu.sd, sd, by = "Var2")
  
  #keep only comparisons within single cover crop type
  wu.sd_test <- wu.sd[wu.sd$Type1 == wu.sd$Type2,]
  #extract time points from sample name
  wu.sd_test$Timeval1 <- str_split(string = wu.sd_test$Var1, "-", n = 5, simplify = T)[,2]
  wu.sd_test$Timeval2 <- str_split(string = wu.sd_test$Var2, "-", n = 5, simplify = T)[,2]
  
  #keep only those comparing to time 0
    wu.sd_test <- wu.sd_test[wu.sd_test$Timeval1 == "t0",]
    #gives the same output, so its working to filter as expected
 # wu.sd_test2 <- wu.sd_test[wu.sd_test$Timeval2 == "t0",]
  
  #remove this line to plot all comparisons. 
  #wu.sd = wu.sd %>% filter(Type1 == "Hand" | Type1 == "Non-Treated")
  
  # plot
  ggplot(wu.sd_test, aes(x = Timeval2, y = value, fill = Type1)) +
    theme_bw() +
    #geom_point() +
   # geom_boxplot(aes(color = ifelse(Type1 == Type2, "red", "black"))) +
    geom_boxplot() +
    scale_color_identity() +
    facet_wrap(~ WheatM.x, scales = "free_x") +
    theme(axis.text.x=element_text(angle = 45, hjust = 1, size = 5)) + 
    ggtitle(paste0("Distance Metric = ", m))
  
}
```

testing code
```{r}
plotDistances = function(p, m, s, d) {

 #p= subset_samples(ps16S_bac_rarefy_iter, WheatM == "WM")
 #  p=ps16S_bac_rarefy_iter
#    m = "bray"
#     s = "sample.names"
#      d = "Covercrop"
  
  # calc distances
  wu = phyloseq::distance(p, m)
  wu.m = melt(as.matrix(wu))
  
  # remove self-comparisons
  wu.m = wu.m %>%
    filter(as.character(Var1) != as.character(Var2)) %>%
    mutate_if(is.factor,as.character)
  
  # get sample data (S4 error OK and expected)
  sd = data.frame(sample_data(p)) %>%
    dplyr::select(s, d, WheatM, time) %>%
    mutate_if(is.factor,as.character)
  sd$Covercrop <- factor(sd$Covercrop, levels = c("NoCC", "Tr", "CC", "2Spp"))
 # sd$Timepoint <- factor(sd$Timepoint, levels = c("to", "t1", "t2", "t3", "t4", "t5", "t6"))
  # combined distances with sample data
  colnames(sd) = c("Var1", "Type1", "WheatM", "time")
  
  wu.sd = left_join(wu.m, sd, by = "Var1")
  
  colnames(sd) = c("Var2", "Type2", "WheatM", "time")
  wu.sd = left_join(wu.sd, sd, by = "Var2")
  
  #keep only comparisons within single cover crop type
  wu.sd_test <- wu.sd[wu.sd$Type1 == wu.sd$Type2,]
  
  #extract time points from sample name
  wu.sd_test$Timeval1 <- str_split(string = wu.sd_test$Var1, "-", n = 5, simplify = T)[,2]
  wu.sd_test$Timeval2 <- str_split(string = wu.sd_test$Var2, "-", n = 5, simplify = T)[,2]
  
  #keep only those comparing to time 0
    wu.sd_test <- wu.sd_test[wu.sd_test$Timeval2 == "t0",]

    
    #simplify the names of the wu.sd.test
  wu.sd_test_plotting <- wu.sd_test %>% dplyr::select(Var1, Var2, value, Type1, WheatM.x, time.x, Type2, Timeval1, Timeval2)
  wu.sd_test_plotting$time <- wu.sd_test_plotting$time.x
  wu.sd_test_plotting$time.x = NULL
   wu.sd_test_plotting$WheatM <- wu.sd_test_plotting$WheatM.x
   wu.sd_test_plotting$WheatM.x = NULL
   
   wu.sd_test_plotting$WheatM <-as.factor(wu.sd_test_plotting$WheatM )
  
  #remove this line to plot all comparisons. 
  #wu.sd = wu.sd %>% filter(Type1 == "Hand" | Type1 == "Non-Treated")
  
  # plot
  ggplot(wu.sd_test_plotting, aes(x = Timeval1, y = value)) +
    theme_bw() +
  #geom_point() +
   # geom_boxplot(aes(color = ifelse(Type1 == Type2, "red", "black"))) +
    geom_boxplot(aes(x = Timeval1, y = value, fill = WheatM)) +
    scale_color_identity() +
    #facet_wrap(~ Type1*WheatM, scales = "free_x", ncol = 2) +
    facet_wrap(~ Type1, scales = "free_x", ncol = 2) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1, size = 5)) + 
    ggtitle(paste0("Distance Metric = ", m)) + geom_smooth(data = wu.sd_test_plotting, aes(group=WheatM,),  se= T, method = "loess") 
  

                                                           
}
```

```{r}
a<-plotDistances(p = subset_samples(physeq= ps16S_bac_rarefy_iter, WheatM == "WM"), m = "bray", s = "sample.names", d = "Covercrop")
a <- a + ggtitle("Time 1 Bray-Curtis Dissimlarities")
a

a<-plotDistances(p = subset_samples(physeq= ps16S_bac_rarefy_iter, WheatM == "NoWM"), m = "bray", s = "sample.names", d = "Covercrop")
a <- a + ggtitle("Time 1 Bray-Curtis Dissimlarities")
a

a<-plotDistances(p = ps16S_bac_rarefy_iter, m = "bray", s = "sample.names", d = "Covercrop")
a <- a + ggtitle("Time 1 Bray-Curtis Dissimlarities")
a
```



DESeq2
```{r}
library(DESeq2)
#Right side of volcano plot (e.g., positive log fold change is associated with first factor in contrasts argument)

diagdds = phyloseq_to_deseq2(subset_samples(ps_16S_bac_rarefy_iter, time == "t0"), ~ treatment)
diagdds = DESeq(diagdds, test="Wald", fitType="parametric")

#effect of nitrogen within well watered
res = results(diagdds, cooksCutoff = FALSE, contrast = c("treatment",  "hnc", "lnc"))
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
sigtabt0hnclnc = cbind(as(sigtab, "data.frame"))
head(sigtabt0hnclnc)

EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue',
    title = 'HNC versus LNC t0',
    pCutoffCol = "padj",
    pCutoff = 10e-3)

#effect of nitrogen within drought
res = results(diagdds, cooksCutoff = FALSE, contrast = c("treatment", "hnd", "lnd"))
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
sigtabt0hndlnd = cbind(as(sigtab, "data.frame"))
head(sigtabt0hndlnd)

EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue',
    title = 'HND versus LND t0',
    pCutoffCol = "padj",
    pCutoff = 10e-3)

#effect of drought within high nitrogen
res = results(diagdds, cooksCutoff = FALSE, contrast = c("treatment", "hnc", "hnd"))
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
sigtabt0hnchnd = cbind(as(sigtab, "data.frame"))
head(sigtabt0hnchnd)

EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue',
    title = 'HNC versus HND t0',
    pCutoffCol = "padj",
    pCutoff = 10e-3)


#effect of drought within low nitrogen
res = results(diagdds, cooksCutoff = FALSE, contrast = c("treatment", "lnc", "lnd"))
alpha = 0.01
sigtab = res[which(res$padj < alpha), ]
sigtabtolnclnd = cbind(as(sigtab, "data.frame"))
head(sigtabtolnclnd)


EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue',
    title = 'LNC versus LND t0',
    pCutoffCol = "padj",
    pCutoff = 10e-3)

boxplot(data.frame(otu_table(subset_samples(ps_16S_bac_rarefy_iter, time == "t0")))$'OTU_54' ~ sample_data(subset_samples(ps_16S_bac_rarefy_iter, time == "t0"))$treatment)

#OTU 54v is assocaited with LNC and HNC when comparing to their respective Drought conditions
```

```



